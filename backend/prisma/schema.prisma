// prisma/schema.prisma

generator client {
  provider = "prisma-client-py"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ADMIN (Sistema de Login) ====================
model Admin {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String   // Hash SHA256
  salt      String   // Salt para segurança
  active    Boolean  @default(true)
  isMaster  Boolean  @default(false)
  
  createdAt DateTime @default(now())
  lastLogin DateTime?
  
  @@map("admins")
}

// ==================== USUÁRIOS (Funcionários) ====================
model User {
  id              Int       @id @default(autoincrement())
  idFaceId        Int?      @unique
  name            String
  registration    String?
  password        String?
  salt            String?
  beginTime       DateTime?
  endTime         DateTime?
  image           String?
  imageTimestamp  DateTime?
  
  cards           Card[]
  qrcodes         QRCode[]
  templates       Template[]
  accessLogs      AccessLog[]
  userGroups      UserGroup[]
  userAccessRules UserAccessRule[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("users")
}

// ==================== VISITANTES ====================
model Visitor {
  id              Int       @id @default(autoincrement())
  idFaceId        Int?      @unique
  name            String
  registration    String    // Empresa do visitante
  image           String?
  imageTimestamp  DateTime?
  beginTime       DateTime
  endTime         DateTime  // Válido até 23:59:59 dessa data
  
  accessLogs      AccessLog[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("visitors")
}

// Cartões de acesso
model Card {
  id        Int      @id @default(autoincrement())
  value     BigInt   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@map("cards")
}

// QR Codes
model QRCode {
  id        Int      @id @default(autoincrement())
  value     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@map("qrcodes")
}

// Templates biométricos
model Template {
  id         Int    @id @default(autoincrement())
  fingerType Int    @default(0)
  template   String
  userId     Int
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime @default(now())
  
  @@map("templates")
}

// Regras de acesso
model AccessRule {
  id       Int    @id @default(autoincrement())
  name     String
  type     Int    @default(1)
  priority Int    @default(0)
  
  idFaceId Int?   @unique
  
  timeZones           AccessRuleTimeZone[]
  userAccessRules     UserAccessRule[]
  groupAccessRules    GroupAccessRule[]
  portalAccessRules   PortalAccessRule[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("access_rules")
}

// Time Zones (Horários)
model TimeZone {
  id        Int      @id @default(autoincrement())
  name      String
  
  idFaceId  Int?     @unique
  
  timeSpans           TimeSpan[]
  accessRuleTimeZones AccessRuleTimeZone[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("time_zones")
}

// Time Spans (Intervalos de tempo)
model TimeSpan {
  id         Int      @id @default(autoincrement())
  timeZoneId Int
  timeZone   TimeZone @relation(fields: [timeZoneId], references: [id], onDelete: Cascade)
  
  idFaceId   Int?
  
  start Int
  end   Int
  
  sun Boolean @default(false)
  mon Boolean @default(false)
  tue Boolean @default(false)
  wed Boolean @default(false)
  thu Boolean @default(false)
  fri Boolean @default(false)
  sat Boolean @default(false)
  
  hol1 Boolean @default(false)
  hol2 Boolean @default(false)
  hol3 Boolean @default(false)
  
  createdAt DateTime @default(now())
  
  @@map("time_spans")
}

// Relacionamento AccessRule <-> TimeZone
model AccessRuleTimeZone {
  id           Int        @id @default(autoincrement())
  accessRuleId Int
  timeZoneId   Int
  
  accessRule AccessRule @relation(fields: [accessRuleId], references: [id], onDelete: Cascade)
  timeZone   TimeZone   @relation(fields: [timeZoneId], references: [id], onDelete: Cascade)
  
  @@unique([accessRuleId, timeZoneId])
  @@map("access_rule_time_zones")
}

// Grupos de usuários
model Group {
  id       Int    @id @default(autoincrement())
  name     String
  
  idFaceId Int?   @unique
  
  userGroups       UserGroup[]
  groupAccessRules GroupAccessRule[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("groups")
}

// Relacionamento User <-> Group
model UserGroup {
  id      Int   @id @default(autoincrement())
  userId  Int
  groupId Int
  
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@unique([userId, groupId])
  @@map("user_groups")
}

// Relacionamento User <-> AccessRule
model UserAccessRule {
  id           Int        @id @default(autoincrement())
  userId       Int
  accessRuleId Int
  
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessRule AccessRule @relation(fields: [accessRuleId], references: [id], onDelete: Cascade)
  
  @@unique([userId, accessRuleId])
  @@map("user_access_rules")
}

// Relacionamento Group <-> AccessRule
model GroupAccessRule {
  id           Int        @id @default(autoincrement())
  groupId      Int
  accessRuleId Int
  
  group      Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  accessRule AccessRule @relation(fields: [accessRuleId], references: [id], onDelete: Cascade)
  
  @@unique([groupId, accessRuleId])
  @@map("group_access_rules")
}

// Portais (Portas/Catracas)
model Portal {
  id   Int    @id @default(autoincrement())
  name String
  
  idFaceId Int? @unique
  
  portalAccessRules PortalAccessRule[]
  accessLogs        AccessLog[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("portals")
}

// Relacionamento Portal <-> AccessRule
model PortalAccessRule {
  id           Int        @id @default(autoincrement())
  portalId     Int
  accessRuleId Int
  
  portal     Portal     @relation(fields: [portalId], references: [id], onDelete: Cascade)
  accessRule AccessRule @relation(fields: [accessRuleId], references: [id], onDelete: Cascade)
  
  @@unique([portalId, accessRuleId])
  @@map("portal_access_rules")
}

// Logs de acesso (Auditoria)
model AccessLog {
  id          Int      @id @default(autoincrement())
  idFaceLogId Int      @unique // ID original do log no dispositivo iDFace
  userId      Int?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  visitorId   Int?
  visitor     Visitor? @relation(fields: [visitorId], references: [id], onDelete: SetNull)
  
  portalId    Int?
  portal      Portal?  @relation(fields: [portalId], references: [id], onDelete: SetNull)
  
  event       String
  reason      String?
  cardValue   String?
  
  timestamp   DateTime @default(now())
  
  @@map("access_logs")
}

// Cargo/Função
model Position {
  id          Int    @id @default(autoincrement())
  name        String @unique
  description String?
  
  defaultStartTime String?
  defaultEndTime   String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("positions")
}